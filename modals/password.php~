<?php

class PassModel extends Model {

	public function Index() {

		if ($_SESSION['admin'] == 1|| $_SESSION['admin'] == 2) {
			$this->query('SELECT password FROM Admins WHERE username = :user');
			$this->bind(':user', $_SESSION['user']);
			$rows = $this->resultSet();
		} 
		else {
			$this->query('SELECT password FROM users WHERE username = :user');
			$this->bind(':user', $_SESSION['user']);
			$rows = $this->resultSet();
		}

		$post  = filter_input_array(INPUT_POST, FILTER_SANITIZE_STRING);

		if($post['submit']) {

			if (md5($post['current_pass']) != $rows[0]['password']) {
				Messages::setMsg('Current Password is wrong', 'error');
			}

			elseif ($post['new_pass'] != $post['check_new_pass']) {
				Messages::setMsg('Passwords does not match', 'error');
			}

			else {
				
				echo md5($post['new_pass']);

				if ($_SESSION['admin'] == 1) {
					$this->query('UPDATE `Admins` SET `password` = :new_pass WHERE `Admins`.`username` = :user;');
					$this->bind(':new_pass', md5($post['new_pass']));
					$this->bind(':user', $_SESSION['user']);
					$this->execute();

					header('Location: '.ROOT_URL.'?controller=admin');
				}
				else {
					$this->query('UPDATE `users` SET `password` = :new_pass WHERE `users`.`username` = :user;');
					$this->bind(':new_pass', md5($post['new_pass']));
					$this->bind(':user', $_SESSION['user']);
					$this->execute();

					header('Location: '.ROOT_URL.'?controller=home');
				}

			}

		}

	}

}
